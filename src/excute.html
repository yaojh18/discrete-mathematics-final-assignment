<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>excute</title>
    <script type="text/javascript" src="http://d3js.org/d3.v5.js"></script>
</head>
<body>
    <button value = "加载论文数据" onclick = draw("paper")></button>
    <svg width="1520" height="730"></svg>
    <script>
        function draw(name){
            var svg = d3.select("svg")
            var width = svg.attr("width")
            var height = svg.attr("height")
            var g = svg.append("g")

            //准备数据
            var paper_loader = d3.csv(name + ".csv", function(d) {
                return{
                    ID:d.ID,
                    closeness_centrality:+d.closeness_centrality,
                    betweenness_centrality:+d.betweenness_centrality,
                    group:+d.group,
                    label:+d.label
                }
            })
            var paepr_connention_loader = d3.csv(name + "_connection.csv", function(d){
                return {source:+d.source,
                    target:+d.target,
                    distance:+d.distance}
            })
            var paper_distance_loader = d3.csv(name + "_distance.csv", function(d){
                var lst = []
                for (var item in d)
                    lst.push(+d[item])
                return lst
            })
            paper_loader.then(function(paper){
                paepr_connention_loader.then(function(paper_connetion){
                    paper_distance_loader.then(function(paper_distance){
                        var betweenness_centrality = []
                        for (var i =0;i<paper.length;i++)
                            betweenness_centrality.push(paper[i].betweenness_centrality)

                        var colorScale = d3.scaleLinear()
                            .domain([d3.min(betweenness_centrality),d3.max(betweenness_centrality)])
                            .range([0,2])
                        function compute_color(color){
                            if (color<0.001)
                                return d3.interpolate(d3.rgb(0,0,255), d3.rgb(0,255,255))(color/0.001)
                            else if (color<0.01)
                                return d3.interpolate(d3.rgb(0,255,255), d3.rgb(0,255,0))((color-0.001)/0.009)
                            else if (color<0.1)
                                return d3.interpolate(d3.rgb(0,255,0), d3.rgb(255,255,0))((color-0.01)/0.09)
                            else
                                return d3.interpolate(d3.rgb(255,255,0), d3.rgb(255,0,0))((color-0.1)/1.9)
                        }
                        //新建一个力导向图
                        var forceSimulation = d3.forceSimulation()
                            .force("link",d3.forceLink())
                            .force("charge",d3.forceManyBody())
                            .force("center",d3.forceCenter())


                        forceSimulation.nodes(paper)
                            .on("tick",ticked);

                        forceSimulation.force("link")
                            .links(paper_connetion)
                            .distance(30)
                            .strength(function(d){
                                return 0.2*Math.pow(d.distance,-1)
                            })

                        forceSimulation.force("center")
                            .x(width/2)
                            .y(height/2);

                        var paper_edges = g.selectAll("edge")
                            .data(paper_connetion)
                            .enter()
                            .append("line")
                            .attr("stroke",d3.rgb(200,200,200))
                            .attr("stroke-width",function(d){
                                return 0.5
                                /*if (d.distance < 8)
                                    return 0.5
                                else
                                    return 0*/
                            });

                        var paper_nodes = g.selectAll("node")
                            .data(paper)
                            .enter()
                            .append("g")
                            .attr("transform",function(d,i){
                                var cirX = d.x;
                                var cirY = d.y;
                                return "translate("+cirX+","+cirY+")";
                            })
                            .call(d3.drag()
                                .on("start",started)
                                .on("drag",dragged)
                                .on("end",ended)
                            )
                            .on("click",function(d){
                                console.log(d.ID)
                            })

                        paper_nodes.append("circle")
                            .attr("r",function(d){
                                return 2+2*colorScale(d.betweenness_centrality)})
                            .attr("fill",function(d){
                                return compute_color(colorScale(d.betweenness_centrality));
                            })
                        //文字备选项
                        /*paper_nodes.append("text")
                            .attr("x",-2)
                            .attr("y",-4)
                            .attr("dy",2)
                            .attr("font-size",4)
                            .text(function(d){
                                return d.ID;
                            })*/

                        function ticked(){
                            paper_edges
                                .attr("x1",function(d){return d.source.x;})
                                .attr("y1",function(d){return d.source.y;})
                                .attr("x2",function(d){return d.target.x;})
                                .attr("y2",function(d){return d.target.y;});

                            paper_nodes
                                .attr("transform",function(d) { return "translate(" + d.x + "," + d.y + ")"; });
                        }
                        function started(d){
                            if(!d3.event.active){
                                forceSimulation.alphaTarget(0.8).restart();
                            }
                            d.fx = d.x;
                            d.fy = d.y;
                        }
                        function dragged(d){
                            d.fx = d3.event.x;
                            d.fy = d3.event.y;
                        }
                        function ended(d){
                            if(!d3.event.active){
                                forceSimulation.alphaTarget(0);
                            }
                            d.fx = null;
                            d.fy = null;
                        }
                    })
                })
            })
        }

    </script>
</body>
</html>